<?xml version="1.0"?>
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at
       http://www.apache.org/licenses/LICENSE-2.0
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<project name="JmeterTest" default="run" basedir="." >
	<tstamp>
        <format property="time" pattern="yyyy-MM-dd-hh-mm-ss" />  
    </tstamp>
	<!-- 必须放在最前面，可以确保能使用到jenkins平台及系统set的环境变量 -->
	<property environment="env"/> 
	<!-- 临时本地调试脚本使用路径-->
	<property name="env.WORKSPACE" value="${basedir}" />
    <!-- 需要改成自己本地的 Jmeter 目录,此前-->
    <property name="jmeter.home" value="${env.JMETER_HOME}" />
	<!--设置接收报告的邮箱地址，多个以逗号,结束！-->
	<property name="mail_to" value="125197291@qq.com"/> 
	<property name="jmeter.result.jtlName" value="${env.WORKSPACE}/jtlResults/index_${time}.jtl" />
    <property name="jmeter.result.htmlName1" value="${env.WORKSPACE}/summaryReport/summaryReport_${time}.html" />
    <property name="jmeter.result.htmlName2" value="${env.WORKSPACE}/detailsReport/detailsReport_${time}.html" />
	
	<property name="report.title" value=" Performance Test Summary Report" />
    <!--标签可以定义中文，定义任务标签，需要执行什么任务，就在这里定义-->
    <target name="run">
		<echo message="Ant执行build.xml"/>
		<antcall target="删除文件" />
        <antcall target="运行脚本" /> 
        <antcall target="summaryReport" />  
        <antcall target="detailsReport" />  
		<!-- antcall target="send_Email" /-->
		<antcall target="备份文件" />
    </target>

    <!--详细任务步骤-->
	<target name="删除文件">
        <!--delete dir="${env.WORKSPACE}" /-->  <!--clean清除文件夹下的文件，要用delete标签属性，删除文件夹dir或文件file-->
		<!--删除标签，删除指定目录下所有后缀的文件-->
		<delete><fileset dir="${env.WORKSPACE}" excludes="**/*.csv,**/*.jmx,**/*.png,**/*.MD,**/*.xml,backUp/**/*.html,**/*.xsl"/></delete>
    </target>

	<!-- jmeter运行脚本所调用到的ant的jar类-->
	<path id="ant.jmeter.classpath">
		<pathelement location="${env.JMETER_HOME}/extras/ant-jmeter-1.1.1.jar" />
	</path>

	<path id="xslt.classpath">
        <fileset dir="${jmeter.home}/lib" includes="xalan*.jar"/>
        <fileset dir="${jmeter.home}/lib" includes="serializer*.jar"/>
    </path>

    <target name="运行脚本">
	    <taskdef name="jmeter" classname="org.programmerplanet.ant.taskdefs.jmeter.JMeterTask" classpathref="ant.jmeter.classpath" />
        <jmeter jmeterhome="${jmeter.home}" resultlog="${jmeter.result.jtlName}">
            <!-- 声明要运行的脚本。"*.jmx"指包含此目录下的所有jmeter脚本 -->
            <testplans dir="${env.WORKSPACE}/jmeterScript" includes="selectTypeInterface.jmx" />
			<!--设置jmeter/bin目录下的jmeter.properties配置项，内容输出格式-->
			<property name="jmeter.save.saveservice.output_format" value="xml" />
        </jmeter>
    </target>

    <!--把生成的.jtl数据文件转换成.html格式的报告 -->
    <target name="summaryReport">
        <xslt  
		classpathref="xslt.classpath" 
		force="true" 
		in="${jmeter.result.jtlName}" 
		out="${jmeter.result.htmlName2}" 
		style="./xlsReports/jmeter-results-detail-report_21.xsl">
		<param name="dateReport" expression="${time}"/>
		</xslt>	
	    <!-- 因为上面生成报告的时候，不会将相关的图片也一起拷贝至目标目录，所以，需要手动拷贝 -->
        <copy todir="${env.WORKSPACE}/detailsReport">
            <fileset dir="${jmeter.home}/extras">
                <include name="collapse.png" />
                <include name="expand.png" />
            </fileset>
        </copy>
     </target>

	<target name="detailsReport">
        <xslt  
		classpathref="xslt.classpath" 
		force="true" 
		in="${jmeter.result.jtlName}" 
		out="${jmeter.result.htmlName1}" 
		style="./xlsReports/jmeter.results.shanhe.me.xsl">
		<param name="dateReport" expression="${time}"/>
		</xslt>	
	</target>

	<target name="备份文件">
		<echo message="删除前备份html/jtl报告文件"/>
		<copy todir="${env.WORKSPACE}/backup">
            <fileset dir="${env.WORKSPACE}">
			<include name="summyReport/"/>
			<include name="detailsReport/"/>
			</fileset>
        </copy>
	</target>

    <!-- 发送邮件 
    <target name="send_Email" >  
        <mail mailhost="smtp.qq.com"  mailport="465"  ssl="true"   user="125197291@qq.com"  password="xlfzgcbkspmzbibd"   subject="接口测试报告"  from="125197291@qq.com" >  
            <to address="125197291@qq.com"/>  
			<message>
				详细报告请查看附件！			
			</message>  
			-->
			<!--携带附件！
              <attachments>  
                <fileset dir="${env.WORKSPACE}">   
                  <include name="backUp/*.html"/>  
                </fileset>   
              </attachments>  
        </mail>  
    </target> 
	-->
</project>
